<!-- Views/CodeDefWindow.xaml -->
<Window x:Class="FourDTools.Views.CodeDefWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="clr-namespace:FourDTools.Converters"
        Title="4D CodeDef Editor" Height="420" Width="680"
        WindowStartupLocation="CenterOwner" ResizeMode="CanResizeWithGrip"
        FontSize="13">

    <Window.Resources>
        <conv:InvertBoolConverter x:Key="invertBool"/>
    </Window.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
            <Button Content="Reload Selection" Width="140" Margin="0,0,8,0"
                    Command="{Binding CmdReloadSelection}"/>
            <Button Content="Prev" Width="70" Margin="0,0,8,0"
                    Command="{Binding CmdPrev}"/>
            <Button Content="Next" Width="70" Margin="0,0,8,0"
                    Command="{Binding CmdNext}"/>
            <Button Content="Save Current" Width="120" Margin="0,0,8,0"
                    Command="{Binding CmdSaveCurrent}"/>
            <Button Content="Save All (Host only)" Width="160" Margin="0,0,8,0"
                    Command="{Binding CmdSaveAll}"/>
            <Button Content="Close" Width="80"
                    Command="{Binding CmdClose}"/>
        </StackPanel>

        <!-- List -->
        <DataGrid Grid.Row="1" ItemsSource="{Binding Items}" AutoGenerateColumns="False" CanUserAddRows="False"
                  IsReadOnly="False" SelectionMode="Single" SelectedIndex="{Binding CurrentIndex, Mode=TwoWay}">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Handle" Binding="{Binding Handle}" IsReadOnly="True" Width="100"/>
                <DataGridTextColumn Header="XREF?" Binding="{Binding IsInXref}" IsReadOnly="True" Width="60"/>
                <DataGridComboBoxColumn Header="4D_Code_Type" SelectedItemBinding="{Binding CodeType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        Width="140">
                    <DataGridComboBoxColumn.ElementStyle>
                        <Style TargetType="ComboBox">
                            <Setter Property="ItemsSource" Value="{Binding DataContext.AllowedTypes, RelativeSource={RelativeSource AncestorType=Window}}"/>
                            <Setter Property="IsEnabled" Value="{Binding IsInXref, Converter={StaticResource invertBool}}"/>
                        </Style>
                    </DataGridComboBoxColumn.ElementStyle>
                    <DataGridComboBoxColumn.EditingElementStyle>
                        <Style TargetType="ComboBox">
                            <Setter Property="ItemsSource" Value="{Binding DataContext.AllowedTypes, RelativeSource={RelativeSource AncestorType=Window}}"/>
                            <Setter Property="IsEditable" Value="False"/>
                            <Setter Property="IsEnabled" Value="{Binding IsInXref, Converter={StaticResource invertBool}}"/>
                        </Style>
                    </DataGridComboBoxColumn.EditingElementStyle>
                </DataGridComboBoxColumn>
                <DataGridTextColumn Header="4D_Code_Value" Binding="{Binding CodeValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                <DataGridTextColumn Header="Dirty" Binding="{Binding IsDirty}" IsReadOnly="True" Width="60"/>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Status -->
        <TextBlock Grid.Row="2" Text="Tip: XREF rows are read-only here. Open the XREF DWG to edit their XData."
                   Foreground="Gray" Margin="0,8,0,0"/>
    </Grid>
</Window>